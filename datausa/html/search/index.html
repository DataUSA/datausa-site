{% extends "templates/nav.html" %}

{% block body %}

<div class="bg">
  <div class="bg-filter"></div>
</div>

<div id="search-advanced">
  <div class="search-nav">
    <input class="search-input" data-search="advanced" type="text" placeholder="Search DataUSA&hellip;" autofocus />
  </div>

  <div class="search-helpers">
    <div class="search-meta">
      <span class="search-suggestions"></span>
    </div>
  </div>

  <div class="search-results-container">
    <div class="search-refine">
      <!-- <h2>Refine By:</h2> -->
      <a href="#" class="clear"><span>&times;</span> Clear Filter</a>

      <div class="geo">
        <h2><a href="#" data-filter="geo"><img src="/static/img/icons/geo_b.svg">Locations <span class="num_res" data-default="143,336">0</span></a></h2>
        <ul>
          <li><a href="#" data-filter="geo" data-depth="040">States <span class="num_res" data-default="52">0</span></a></li>
          <li><a href="#" data-filter="geo" data-depth="050">Counties <span class="num_res" data-default="3,221">0</span></a></li>
          <li><a href="#" data-filter="geo" data-depth="310">Metro Areas <span class="num_res" data-default="1,006">0</span></a></li>
          <li><a href="#" data-filter="geo" data-depth="160">Places <span class="num_res" data-default="29,533">0</span></a></li>
          <li><a href="#" data-filter="geo" data-depth="795">PUMAs <span class="num_res" data-default="2,378">0</span></a></li>
        </ul>
      </div>

      <div class="naics">
        <h2><a href="#" data-filter="naics"><img src="/static/img/icons/naics_b.svg">Industries <span class="num_res" data-default="301">0</span></a></h2>
        <ul>
          <li><a href="#" data-filter="naics" data-depth="0">Sector <span class="num_res" data-default="14">0</span></a></li>
          <li><a href="#" data-filter="naics" data-depth="1">Subsector <span class="num_res" data-default="21">0</span></a></li>
          <li><a href="#" data-filter="naics" data-depth="2">Group <span class="num_res" data-default="266">0</span></a></li>
        </ul>
      </div>

      <div class="soc">
        <h2><a href="#" data-filter="soc"><img src="/static/img/icons/soc_b.svg">Occupations <span class="num_res" data-default="525">0</span></a></h2>
        <ul>
          <li><a href="#" data-filter="soc" data-depth="0">Major Group <span class="num_res" data-default="6">0</span></a></li>
          <li><a href="#" data-filter="soc" data-depth="1">Minor Group <span class="num_res" data-default="17">0</span></a></li>
          <li><a href="#" data-filter="soc" data-depth="2">Broad Occupation <span class="num_res" data-default="24">0</span></a></li>
          <li><a href="#" data-filter="soc" data-depth="3">Detailed Occupation <span class="num_res" data-default="478">0</span></a></li>
        </ul>
      </div>

      <div class="cip">
        <h2><a href="#" data-filter="cip"><img src="/static/img/icons/cip_b.svg">Education <span class="num_res" data-default="2,319">0</span></a></h2>
        <ul>
          <li><a href="#" data-filter="cip" data-depth="0">2 Digit Course <span class="num_res" data-default="49">0</span></a></li>
          <li><a href="#" data-filter="cip" data-depth="1">4 Digit Course <span class="num_res" data-default="422">0</span></a></li>
          <li><a href="#" data-filter="cip" data-depth="2">6 Digit Course <span class="num_res" data-default="1,848">0</span></a></li>
          <li class="stem_only"><a href="#" data-filter="cip" data-stem="2">STEM Only <span class="check"><input type="checkbox" name="stem" value="stem" checked="checked"></span></a></li>
        </ul>
      </div>

    </div>

    <div class="search-results-dynamic">
      <div class="search-autocorrected">
        No results found. Showing results for <span class="result"></span> instead.
      </div>
      <div class="no-search-results">No results found</div>
      <div class="search-results">
        <div class="search-item">
          <div class="thumb" style="background: url('/static/img/thumb/geo/01000US.jpg');"></div>
          <div class="info">
            <h2>United States of America</h2>
            <p class="subttile">Nation</p>
          </div>
          <div class="profile">
            <a href="#">View Profile &raquo;</a>
          </div>
        </div>
        <div class="search-item">
          <div class="thumb" style="background: url('/static/img/thumb/geo/01000US.jpg');"></div>
          <div class="info">
            <h2>Indiana</h2>
            <p class="subttile">State</p>
          </div>
          <div class="profile">
            <a href="#">View Profile &raquo;</a>
          </div>
        </div>
        <div class="search-item active">
          <div class="thumb" style="background: url('/static/img/thumb/geo/01000US.jpg');"></div>
          <div class="info">
            <h2>Economy, IN</h2>
            <p class="subttile">Census Designated Place</p>
            <p class="bcrumb">
              <a href="/profile/geo/01000US/">United States</a> / <a href="/profile/geo/04000US18/">Indiana</a> / <a href="/profile/geo/05000US18177/">Wayne County</a> / <a href="/profile/geo/31000US39980/">Richmond, IN</a> / <a href="/profile/geo/79500US1802600/">Wayne, Fayette, Rush &amp; Union Counties PUMA</a>
            </p>
            <div class="details-anchors"><ul><li><h3><a href="/profile/geo/16000US1820152/#economy">Economy</a></h3><p>Here we present trends in jobs, wages, industries and family structures over time in Economy, IN.</p></li><li><h3><a href="/profile/geo/16000US1820152/#demographics">Demographics</a></h3><p>The American Community Survey collects information on the demographics and origins of the residents in Economy, IN.</p></li><li><h3><a href="/profile/geo/16000US1820152/#education">Education</a></h3><p>The Census Bureau collects a large amount of data regarding higher education.</p></li><li><h3><a href="/profile/geo/16000US1820152/#housing">Housing &amp; Living</a></h3><p>The American Census Survey contains a lot of rich information pertaining to households and the people that reside in them.</p></li><li><h3><a href="/profile/geo/16000US1820152/#health">Health &amp; Safety</a></h3><p>The University of Wiconsin has collected data on various health and safety factors, and created a ranking for each.</p></li></ul></div>
          </div>
          <div class="profile">
            <a href="#">View Profile &raquo;</a>
          </div>
        </div>
        <div class="search-item">
          <div class="thumb" style="background: url('/static/img/thumb/geo/01000US.jpg');"></div>
          <div class="info">
            <h2>Wayne, Fayette, Rush &amp; Union Counties</h2>
            <p class="subttile">Public Use Micro Area</p>
          </div>
          <div class="profile">
            <a href="#">View Profile &raquo;</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> <!-- end #search-advanced -->
{% endblock %}

{% block js %}
<script>

  localforage.getItem("homepage_image", function(e, d){
    if (!d) d = "1";
    d3.select(".bg-filter").style("background-image", "url('/static/img/home/bg/" + d + ".jpg')");
  });

  search.anchors = {{anchors|safe}};

  function getURLParameter(name) {
    return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
  }

  /*
   * Listen for search filters on left-hand nav
   */
  d3.selectAll(".search-refine a").on("click", function(){
    // prevent default anchor link behavior
    d3.event.preventDefault();
    d3.select(".search-suggestions a.clear").style("display", "inline-block");
    var filter = d3.select(this).attr("data-filter");
    var depth = d3.select(this).attr("data-depth");
    var stem_only = d3.select(this).attr("data-stem");
    var parent_div = this.parentNode.parentNode;
    var is_active = d3.select(parent_div).classed("active");
    if(depth === null && stem_only === null) {
      d3.selectAll(".search-refine > div").classed("active", false);
      d3.select(parent_div).classed("active", !is_active);
      if(!is_active === false){
        d3.select("a.clear").style("display", "none");
        filter = null;
      }
    }
    else if (stem_only){
      d3.select(this).classed("active", !d3.select(this).classed("active"));
      stem_only = d3.select(this).classed("active");
      var active_cip_depth = d3.select(this.parentNode.parentNode).selectAll("li:not(.stem_only) a.active");
      if(!active_cip_depth.empty()){
        depth = active_cip_depth.attr("data-depth");
      }
      console.log(depth)
    }
    else {
      d3.selectAll(".search-refine div ul li:not(.stem_only) a").classed("active", false);
      d3.select(this).classed("active", true);
      if(!d3.select(this.parentNode.parentNode).select(".stem_only").empty()){
        stem_only = d3.select(".stem_only a").classed("active");
      }
    }

    search.type = filter;
    search.depth = depth;
    search.stem_only = stem_only;
    search.reload();
  })

  /*
   * Clear filters
   */
  d3.select("a.clear").on("click", function(){
    // prevent default anchor link behavior
    d3.event.preventDefault();
    d3.select(this).style("display", "none");
    d3.selectAll(".search-refine > div").classed("active", false);
    d3.selectAll(".search-refine div ul li a").classed("active", false);
    search.type = null;
    search.depth = null;
    search.stem_only = null;
    search.reload();
  })

  /*
   * Constrain search to specific types of attrs
   */
  d3.selectAll(".search-filter").on("click", function(){

    // prevent default anchor link behavior
    d3.event.preventDefault();

    // set constrained search mode
    search.type = d3.select(this).attr("data-filter");

    // close inner dropdown and set title
    d3.select(".search-filters-options").style("opacity", 0).style("display", "none");
    d3.select(".search-filters-toggle-label").text(d3.select(this).text())

    // set active link for profile type
    d3.selectAll(".search-filters-options-inner a").classed("active", false)
    d3.select(this).classed("active", true)

    // show appropriate nesting levels
    d3.selectAll(".search-nestings > div").style("display", "none")
    d3.select(".search-nestings-"+search.type).style("display", "block")

    // activate first nesting level if no levels been selected previously
    if(search.type){
      var active_nesting = d3.selectAll(".search-nestings-"+search.type+" a").filter(function(){
        return d3.select(this).classed("active")
      })
      active_nesting = active_nesting.size() ? active_nesting : d3.select(".search-nestings-"+search.type+" a");
      active_nesting.on("click")(active_nesting.node())
    }
    else {
      search.reload();
    }
  })

  /*
   * Constrain search to specific nesting/sumlevel of attrs
   */
  d3.selectAll(".search-nestings a").on("click", function(active_el){

    // prevent default anchor link behavior
    d3.event.preventDefault();

    var _this = active_el || this;
    var depth = d3.select(_this).attr("data-depth");

    // set constrained search mode with appropriate sumlevel
    // search.term = "";
    if(depth){
      search.current_depth[search.type] = d3.select(_this).attr("data-depth");
    }
    search.reload();

    // set active link for profile type
    d3.select(_this.parentNode).selectAll("a").classed("active", false)
    d3.select(_this).classed("active", true)
  })

  d3.select(".search-filters-toggle").on("click", function(){
    var current_opacity = parseInt(d3.select(".search-filters-options").style("opacity"));
    var current_display = d3.select(".search-filters-options").style("display");
    d3.select(".search-filters-options")
      .style("opacity", (current_opacity+1)%2)
      .style("display", current_display=="block"?"none":"block")
    d3.event.stopPropagation();
  })

  var term = location.search ? location.search.split("=")[1] : "";
  search.term = getURLParameter("q") || "";
  search.type = getURLParameter("kind");
  search.stem_only = getURLParameter("stem_only");
  search.advanced = true;
  search.container = d3.select("#search-advanced");

  if(getURLParameter("kind")){
    d3.select(".search-refine div."+getURLParameter("kind")).classed("active", true);
  }
  if(getURLParameter("stem_only")){
    d3.select(".search-refine .stem_only a").classed("active", true);
  }

  var input = d3.selectAll(".search-input").attr("value", search.term);
  if (input.node().setSelectionRange !== undefined) {
    input.node().setSelectionRange(search.term.length, search.term.length);
  }
  input.on("click", function(){
    d3.event.stopPropagation();
  })

  search.reload();



  d3.select(document).on("keyup.adv_search", function(){
    var search_items = Array.prototype.slice.call(document.querySelectorAll(".search-item"));
    var focused_a = d3.select(".search-item .info a:focus").node();
    var focused_i = -1;
    if(focused_a){
      var focused_search_item = focused_a.parentNode.parentNode.parentNode;
      focused_i = search_items.indexOf(focused_search_item);
    }

    // Up/Down Arrows
    if (d3.event.keyCode === 40 || d3.event.keyCode === 38) {
      var direction = d3.event.keyCode === 40 ? 1 : -1;
      var next_search_item = search_items[focused_i+direction];
      if(next_search_item){
        d3.select(next_search_item).select(".info a").node().focus();
      }
    }

    // Enter
    if (d3.event.keyCode === 13 && focused_a) {
      window.location = focused_a.href;
    }

  })

</script>
{% endblock %}
